<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Maas Terminal</title>
    <script src="/wetty/socket.io/socket.io.js"></script>
    <script>

      var termVisibility = true;

      function toggleTerm() {
        termVisibility = termVisibility == false ? true : false;
        if (termVisibility) {
          document.getElementById("terminal").style.visibility= 'visible' ;
          document.getElementById("editor").style.visibility= 'hidden' ;
          document.getElementById("terminal").focus();
          
        } else {
          document.getElementById("terminal").style.visibility= 'hidden' ;
          document.getElementById("editor").style.visibility= 'visible' ;
          document.getElementById("editor").focus();
          editor.focus();
        }
      }

      function sshToTarget() {
        let url = new URL(window.location.href);
        let searchParams = new URLSearchParams(url.search);
        term.io.sendString('ssh -i .ec2.pem ubuntu@' + searchParams.get('targetNode') + "\n");        
        document.getElementById("terminal").focus();
      }
      function launchCLI() {
        term.io.sendString('sudo docker exec -it solace bash -c "cd /usr/sw/loads/currentload/bin; cli -A" \n');
        document.getElementById("terminal").focus();
      }
    </script>

    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0px;
      }
      #overlay {
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgba(0,0,0,0.75);;
        display: none;
        z-index: 100;
      }
      #overlay input {
        display: inline;
        margin: auto;
        position: relative;
        top: 50%;
        transform: translateY(-50%);
      }
      #terminal {
        top: 32px;
        display: block;
        position: absolute;
        width: 100%;
        height: 90%;
      }
      #editor {
        top: 32px;
        display: block;
        position: absolute;
        width: 100%;
        height: 90%;
      }
      #utilbtn {
        display: inline-block;
        vertical-align: top;
      }
    </style>
  </head>
  <body>
    <div id="utilbtn"><input type="button" onclick="sshToTarget();" value="SSH to VMR"i/></div>
    <div id="utilbtn"><input type="button" onclick="launchCLI();" value="VMR CLI"i/></div>
    <div id="utilbtn"><input type="button" onclick="toggleTerm();" value="Toggle Notepad"i/></div>
    
    <div id="overlay"><input type="button" onclick="location.reload();" value="reconnect" /></div>
    
    <div id="terminal"></div>
    <script src="/wetty/wetty.min.js"></script>

    <div id="editor" style="visibility: hidden">Take some notes..</div>
    <script src="ace/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="ace/src-min/theme_tomorrow_night_blue.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var editor = ace.edit("editor");
        editor.setShowPrintMargin(false);
        editor.setTheme("ace/theme/tomorrow_night_blue");
        if (localStorage && localStorage.getItem('MaasTermNotes') != null) {
          editor.session.setValue(localStorage.getItem('MaasTermNotes'));
        }
        editor.commands.addCommand({
            name: 'save',
            bindKey: {win: "Ctrl-S", "mac": "Cmd-S"},
            exec: function(editor) {
              console.log("Saving edits to local storage.", editor.session.getValue())
              localStorage.setItem("MaasTermNotes", editor.getValue())
            }
        })
        editor.commands.addCommand({
            name: 'openURL',
            bindKey: {win: "Ctrl-O", "mac": "Cmd-O"},
            exec: function(editor) {
              var selectedText = editor.getSession().doc.getTextRange(editor.selection.getRange());
              const isUrl = string => {
                try { 
                  return Boolean(new URL(string)); }
                catch(e) {
                  return false; 
                }
              }
              var destination = selectedText
              if (! isUrl(selectedText)) {
                // Do Google Search
                destination = "https://google.com/search?q=" + encodeURI(selectedText);
              }
              var win = window.open(destination, '_blank');
              win.focus();
            }
        })
        editor.commands.addCommand({
            name: 'execInTerm',
            bindKey: {win: "Ctrl-E", "mac": "Cmd-E"},
            exec: function(editor) {
              var selectedText = editor.getSession().doc.getTextRange(editor.selection.getRange());
              toggleTerm();
              term.io.sendString(selectedText + "\n");        
            }
        })
        editor.commands.addCommand({
            name: 'toggleToTerm',
            bindKey: {win: "Ctrl-T", "mac": "Cmd-T"},
            exec: function(editor) {
              toggleTerm();
            }
        })
    </script>

  </body>
</html>
